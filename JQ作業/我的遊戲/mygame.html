<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My ARPG game</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
        integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">

    <style>
        html {
            height: 100%;
        }

        body {
            background-color: #34495e;
            box-sizing: border-box;
            height: 100vh;
        }

        .wrap {
            width: 100%;
        }

        .content {
            color: #ecf0f1;
            text-align: center;
        }

        h2 {
            font-weight: bold;
        }

        #gameName {
            padding: 1rem 0;
        }

        .game_area {
            /* overflow: hidden; */
            position: relative;
        }

        #author {
            padding: 0.5rem 0;
            margin: 0;
        }



        /* rpg item */
        #hero {
            position: absolute;
            width: 48px;
            height: 48px;
            top: 50%;
            left: 50%;
        }

        #hero img {
            width: 100%;
            height: 100%;
        }
    </style>
</head>

<body>
    <div class="wrap container-fluid mx-auto">
        <div class="content">
            <h2 id="gameName">小杰快打</h2>
            <div class="game_area mx-auto">
            </div>
            <h4 id="author">Created by Jaycub</h4>
        </div>


    </div>




    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
        integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
        integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"
        integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV"
        crossorigin="anonymous"></script>




    <script>
        // Create the canvas
        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");
        canvas.width = 1600;
        canvas.height = 800;
        $('.game_area').append(canvas);


        // Background image
        let bgReady = false;
        let bgImage = new Image();
        bgImage.onload = function () {
            bgReady = true;
        };
        bgImage.src = "./我的素材/battle_field.jpg";

        // Hero image
        let heroReady = false;
        let heroImage = new Image();
        heroImage.onload = () => {
            heroReady = true;
        };
        heroImage.src = "./我的素材/向下-2.png";

        // 1 left 2 right 
        let hero_direction = null;


        //strike shockwave image
        let shockwaveReady = false;
        let shockwaveImage = new Image();
        shockwaveImage.onload = () => {
            shockwaveReady = true;
        };
        shockwaveImage.src = "";
        let strike_once = false;


        // Game objects
        const hero = {
            speed: 256, // movement in pixels per second
            x: 0,
            y: 0
        };
        let monster = [];

        let shockwave = [];

        let monstersKill = 0;

        //let motion smooth - player input
        const keysDown = {};

        addEventListener("keydown", function (e) {
            keysDown[e.keyCode] = true;
            //only strike once
            if (e.keyCode == 81) {
                strike_once = true;
            };
        }, false);

        addEventListener("keyup", function (e) {
            delete keysDown[e.keyCode];
            strike_once
        }, false);

        //change pic make gif
        let gif_loop_number = 1;

        // Update game objects
        const update = (modifier) => {
            if (gif_loop_number >= 20) {
                gif_loop_number = 1;
            };
            if (38 in keysDown) { // Player holding up
                if (gif_loop_number >= 20) {
                    gif_loop_number = 1;
                };
                if (gif_loop_number >= 5) {
                    heroImage.src = `./我的素材/向上-1.png`;
                };
                if (gif_loop_number >= 10) {
                    heroImage.src = `./我的素材/向上-2.png`;
                };
                if (gif_loop_number >= 15) {
                    heroImage.src = `./我的素材/向上-3.png`;
                };
                if (hero.y > 300) {
                    hero.y -= hero.speed * modifier;    //top border
                };

                gif_loop_number += 1;
                hero_direction = null;
            };
            if (40 in keysDown) { // Player holding down
                if (gif_loop_number >= 20) {
                    gif_loop_number = 1;
                }
                if (gif_loop_number >= 5) {
                    heroImage.src = `./我的素材/向下-1.png`;
                };
                if (gif_loop_number >= 10) {
                    heroImage.src = `./我的素材/向下-2.png`;
                };
                if (gif_loop_number >= 15) {
                    heroImage.src = `./我的素材/向下-3.png`;
                };
                if (hero.y < 700) {
                    hero.y += hero.speed * modifier;    //bottom border
                };

                gif_loop_number += 1;
                hero_direction = null;
            }
            if (37 in keysDown) { // Player holding left
                if (gif_loop_number >= 20) {
                    gif_loop_number = 1;
                };
                if (gif_loop_number >= 5) {
                    heroImage.src = `./我的素材/向左走路-1.png`;
                };
                if (gif_loop_number >= 10) {
                    heroImage.src = `./我的素材/向左走路-2.png`;
                };
                if (gif_loop_number >= 15) {
                    heroImage.src = `./我的素材/向左走路-3.png`;
                };
                if (hero.x > 0) {
                    hero.x -= hero.speed * modifier;   //left border
                };

                gif_loop_number += 1;
                hero_direction = 1;
            }
            if (39 in keysDown) { // Player holding right
                if (gif_loop_number >= 20) {
                    gif_loop_number = 1;
                }
                if (gif_loop_number >= 5) {
                    heroImage.src = `./我的素材/向右走路-1.png`;
                };
                if (gif_loop_number >= 10) {
                    heroImage.src = `./我的素材/向右走路-2.png`;
                };
                if (gif_loop_number >= 15) {
                    heroImage.src = `./我的素材/向右走路-3.png`;
                };
                if (hero.x < 1520) {
                    hero.x += hero.speed * modifier;    //right border
                };

                gif_loop_number += 1;
                hero_direction = 2;
            }
            if (81 in keysDown) { // Player holding right
                if (hero_direction == 1) {

                    heroImage.src = `./我的素材/left-attack-1.png`;
                    setTimeout(() => {
                        heroImage.src = `./我的素材/向左走路-2.png`;
                    }, 400);
                    // hero.x += hero.speed * modifier;
                };
                if (hero_direction == 2) {

                    heroImage.src = `./我的素材/right-attack-1.png`;
                    setTimeout(() => {
                        heroImage.src = `./我的素材/向右走路-2.png`;
                    }, 400);
                    // hero.x += hero.speed * modifier;
                };
                if (strike_once == true) {
                    shockwave.push({
                        speed: 300, // movement in pixels per second
                        x: hero.x,
                        y: hero.y,
                        direction: hero_direction,
                    });
                    strike_once = false;
                };
            };


            //skill effect fly
            if (shockwave.length) {
                shockwave.forEach(item => {
                    if (item.direction == 2) {
                        item.x += item.speed * modifier;
                        item.speed += 50;
                    };
                    if (item.direction == 1) {
                        item.x -= item.speed * modifier;
                        item.speed += 50;
                    };
                });
            };
        };


        // Draw everything
        const render = () => {
            let exist_shockwave = [];
            ctx.clearRect(0, 0, canvas.width, canvas.height);  // clear canvas recycle memory

            if (bgReady) {
                ctx.drawImage(bgImage, -100, 0, 1800, 800);
            }

            if (heroReady) {
                ctx.drawImage(heroImage, hero.x, hero.y, 80, 80);
            }
            if (shockwave.length) {
                // console.log(shockwave);
                shockwave.forEach((item) => {
                    if (item.direction == 1) {
                        shockwaveImage.src = './我的素材/shockwave01.png';
                        ctx.drawImage(shockwaveImage, item.x, item.y, 80, 80);
                    };
                    if (item.direction == 2) {
                        shockwaveImage.src = './我的素材/shockwave02.png';
                        ctx.drawImage(shockwaveImage, item.x, item.y, 80, 80);
                    };
                    if (item.x > 0 && item.x < 1600) {   //recycle memory
                        exist_shockwave.push(item);
                    };
                });
            };

            shockwave = exist_shockwave;

            // Score
            ctx.fillStyle = "rgb(44, 62, 80)";
            ctx.font = "36px Helvetica bold";
            ctx.textAlign = "left";
            ctx.textBaseline = "top";
            ctx.fillText("Enimies killed: " + monstersKill, 80, 20);
        };


        // Reset the game when the player catches a monster
        const reset = () => {
            hero.x = canvas.width / 2;
            hero.y = canvas.height / 2;

            // Throw the monster somewhere on the screen randomly
            monster.x = 32 + (Math.random() * (canvas.width - 64));
            monster.y = 32 + (Math.random() * (canvas.height - 64));
        };


        // The main game loop
        const main = () => {
            let now = Date.now();
            let delta = now - then;
            update(delta / 1000);
            render();
            then = now;

            // Request to do this again ASAP
            requestAnimationFrame(main);
        };


        //game start
        let then = Date.now();
        reset();
        main();

    </script>
</body>

</html>